---
title: "Analysis"
output: html_document
---


```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/Setup.R"))
```


### Work environment 


We decide to do a cluster analysis to see if there is some prevalence of certain region compared to others, and also wanted to study our problem through another perspective, that of the countries. Indeed, we could notice on the first plots, some countries adopt more extreme behaviors (position separated from the others) and it is often the same across the different variables.  A good way to analyze this is to group our countries using clusters. The goal is to see if the work environment has more impact in some countries
than in others on the mental health of its population. This is also where we will use our table of averages that we made for each of the variables.


# ATTENTION MARCHE PAS SI NA DONC JE LES ENLEVE POUR L'INSTANT
```{r}
tab_mean_na <- na.omit(tab_mean)
```
# Table ? : Cluster analysis for each of our explanatory variables
```{r}
# Income Inequality
data_t0 <- tab_mean_na[-1]
data_t0 <- data_t0[,c(2,1)]
mean_data <- apply(data_t0, 2, mean)
std <- apply(data_t0,2,sd)
data_t0_std <- scale(data_t0, mean_data, std)
row.names(data_t0_std) <- tab_mean_na[,1]
distance <- dist(data_t0_std)
hc <- hclust(distance)
avclust <- hclust(distance, method = "average")
km.res <- kmeans(data_t0_std, 5)
C0 <- fviz_cluster(km.res, data=data_t0_std, repel = TRUE) 

# Wages
data_t1 <- tab_mean_na[-1]
data_t1 <- data_t1[,c(3,1)]
mean_data <- apply(data_t1, 2, mean)
std <- apply(data_t1,2,sd)
data_t1_std <- scale(data_t1, mean_data, std)
row.names(data_t1_std) <- tab_mean_na[,1]
distance <- dist(data_t1_std)
hc <- hclust(distance)
avclust <- hclust(distance, method = "average")
km.res <- kmeans(data_t1_std, 5)
C1 <- fviz_cluster(km.res, data=data_t1_std, repel = TRUE)

# Unemployment
data_t2 <- tab_mean_na[-1]
data_t2 <- data_t2[,c(4,1)]
mean_data <- apply(data_t2, 2, mean)
std <- apply(data_t2,2,sd)
data_t2_std <- scale(data_t2, mean_data, std)
row.names(data_t2_std) <- tab_mean_na[,1]
distance <- dist(data_t2_std)
hc <- hclust(distance)
avclust <- hclust(distance, method = "average")
km.res <- kmeans(data_t2_std, 5)
C2 <- fviz_cluster(km.res, data=data_t2_std, repel = TRUE)

# Working Age
data_t3 <- tab_mean_na[-1]
data_t3 <- data_t3[,c(5,1)]
mean_data <- apply(data_t3, 2, mean)
std <- apply(data_t3,2,sd)
data_t3_std <- scale(data_t3, mean_data, std)
row.names(data_t3_std) <- tab_mean_na[,1]
distance <- dist(data_t3_std)
hc <- hclust(distance)
avclust <- hclust(distance, method = "average")
km.res <- kmeans(data_t3_std, 5)
C3 <- fviz_cluster(km.res, data=data_t3_std, repel = TRUE)

# GDP
data_t5 <- tab_mean_na[-1]
data_t5 <- data_t5[,c(7,1)]
mean_data <- apply(data_t5, 2, mean)
std <- apply(data_t5,2,sd)
data_t5_std <- scale(data_t5, mean_data, std)
row.names(data_t5_std) <- tab_mean_na[,1]
distance <- dist(data_t5_std)
hc <- hclust(distance)
avclust <- hclust(distance, method = "average")
km.res <- kmeans(data_t5_std, 5)
C4 <- fviz_cluster(km.res, data=data_t5_std, repel = TRUE)

# Put all the graphs together
plot_grid(C0, C1, C2, C3, C4, labels=c("A","B","C","D","E","F"), ncol=2, nrow=3)
```

This table ? shows us that, regardless of the work environment variable, we always have a clear demarcation. Indeed, it is always the same countries in the same places. We can therefore conclude that each region has its own specificities related to the work environment that impact the rate of mental health disorders. 

It would therefore be interesting to see how these behave according to the regions. 

# Table ?? : Impact of work environment's variables on mental health disorders by region 
```{r}
GG00 <- tab %>% ggplot(aes(
  x = Income_Inequality,
  y = Mental_Health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Pas encore de titre") +
  xlab("Income inequality") + ylab("Prevalence of mental health value in %") 
ggplotly(GG00)

GG11 <- tab %>% ggplot(aes(
  x = Wages,
  y = Mental_Health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Pas encore de titre") +
  xlab("wage") + ylab("Prevalence of mental health value in %") 
ggplotly(GG11)

GG22 <- tab %>% ggplot(aes(
  x = Unemployment,
  y = Mental_Health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Pas encore de titre") +
  xlab("Unemployment") + ylab("Prevalence of mental health value in %") 
ggplotly(GG22)

GG33 <- tab %>% ggplot(aes(
  x = Working_Age,
  y = Mental_Health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Pas encore de titre") +
  xlab("Working age") + ylab("Prevalence of mental health value in %") 
ggplotly(GG33)

GG44 <- tab %>% ggplot(aes(
  x = GDP,
  y = Mental_Health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Pas encore de titre") +
  xlab("GDP") + ylab("Prevalence of mental health value in %") 
ggplotly(GG44)
````


#### COVID 


```{r, echo = FALSE, message = FALSE}
Reg2 <- lm(tab_R2.1$Consumption~tab_R2.1$Cases)
summary(Reg2)
cor(tab_R2.1$Consumption, tab_R2.1$Deaths)
cor(tab_R2.1$Consumption, tab_R2.1$Cases)
```


We obtain a correlation of "0,0049" between antidepressant consumption and the number of deaths due to covid, and a correlation of "0,0453" between antidepressant consumption and Covid cases.  
Unfortunately, we can see that there is no correlation between these variables, either with the number of cases or the number of deaths. 
We can give several explanations to this surprising observation.
The first one is the lack of data. Indeed, we were able to study the evolution of antidepressant consumption in only 8 countries. Perhaps with more countries, we would have seen a more significant difference. 

The second and the most likely, is that we can see that the number of cases (and deaths) related to covid are huge numbers, going from 0 to several millions (to thousands). However, compared to these numbers, the value of antidepressants consumption is increasing well as we can see in the graph below but not as much as the number of cases. The ratio is not the same. It would be interesting, later on, to calculate the value of the increase in consumption, by years and see if we can observe a difference between years or not. 

```{r, echo = FALSE, message = FALSE}
#Tableau antidepresseurs, croissance chaque annÃ©e
tab_R2.1G <- ddply(Antidepressant_consumption2, .(LOCATION),
                                  function (d) {
                                    d$Growth <- c(NA, tail(d$Consumption, -1) - head(d$Consumption, -1))
                                    d
                                  }
)

#Tableau croissance jusqu'en 2019
tab_R2.1.2019 <- tab_R2.1G %>%
  group_by(LOCATION,Growth) %>%
  filter(TIME< 2020)

#Moyenne croissance jusqu'en 2019
tab_R2.1mean <-aggregate(tab_R2.1.2019[,4], list(tab_R2.1.2019$LOCATION), mean, na.rm=T)
tab_R2.1mean <-rename(tab_R2.1mean, "LOCATION" = "Group.1")

#Tableau conso 2020 et croissance entre 2019 et 2020
tab_R2.1.G2020 <- tab_R2.1 %>%
  group_by(LOCATION,Growth) %>%
  filter(TIME == 2020)
  
#Tableau croissance entre 2019 et 2020
tab_R2.1.G2020 <-tab_R2.1.G2020[-3]

#Tableau moyenne croissance jusqu'en 2019 et croissance 2019/2020
comparaison <- merge(tab_R2.1mean,tab_R2.1.G2020, by = c("LOCATION"))
comparaison <- rename(comparaison, c("Growth_mean"="Growth.x","Growth2020"="Growth.y"))
comparaison <- comparaison[-3]

#Tableau moyenne conso jusqu'en 2019 
consumptionMean <- aggregate(tab_R2.1.2019[,3], list(tab_R2.1.2019$LOCATION), mean)
consumptionMean <-rename(consumptionMean, "LOCATION" = "Group.1")

#On ajoute conso moyenne a comparaison
comparaison <- merge(comparaison,consumptionMean, by = c("LOCATION"))
comparaison <- rename(comparaison,"Consumption_mean"="Consumption")

#Tableau Conso 2020
consumption2020 <- tab_R2.1 %>%
  group_by(LOCATION,Consumption) %>%
  filter(TIME == 2020)
consumption2020 <- consumption2020[-4]

#On ajoute conso 2020 a comparaison 
comparaison <- merge(comparaison,consumption2020, by = c("LOCATION"))
comparaison <- comparaison[-5]
comparaison <- rename(comparaison,"Consumption2020"="Consumption")

kabble(comparaison)
```












