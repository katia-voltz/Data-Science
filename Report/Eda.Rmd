---
title: "Eda"
output: html_document
---


```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/Setup.R"))
```


Now all our databases are clean and ready to be used. 

# Exloratory data analysis:

- Visualization and representation of tables 
- Identification of relevant variables
- Interpretation of graphs and regressions

1/ Plot the all Tab
2/ Make assumptions about correlations between Y and Xi (by visualization of plot)
3/ Deeper visualization with ggplot between Y and Xi
4/ Create a linear regression
5/ Interpretation of regression and graphs


## Work environment 

### Analysis

The final table and its plot that we obtain in Data.Rmd allow us to do correlation tests and to have visual representations of all these movements.

1. Income Inequality Analysis 

````{r}
reg0 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality)
summary(reg0)
plot(tab_Tot$Income_Inequality, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Income_Inequality, y = Mental_Health, color = LOCATION))
```

We have *  and we can see that the higher the income inequality, the higher the share of the population with mental health disorders is.

2. Wages Analysis

````{r}
reg1 <- lm(tab_Tot$Mental_Health~tab_Tot$wages)
summary(reg1)
plot(tab_Tot$wages, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = wages, y = Mental_Health , color = LOCATION))
```

We have **  and we can see that the higher the wages, the higher the share of the share of the population with mental health disorders is.

3. Unemployment Analysis

````{r}
reg2 <- lm(tab_Tot$Mental_Health~tab_Tot$Unemployment)
summary(reg2)
plot(tab_Tot$Unemployment, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Unemployment, y = Mental_Health , color = LOCATION))
```

We have 0 and it doesn't seem to have any distinct correlation between this two variables.

4. Working Age Analysis

````{r}
reg3 <- lm(tab_Tot$Mental_Health~tab_Tot$Working_Age)
summary(reg3)
plot(tab_Tot$Working_Age, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Working_Age, y = Mental_Health , color = LOCATION))
```

We have ** and we can see that the share of the population with mental health disorders is higher when the working age is lower.

5. Work Time Analysis

````{r}
reg4 <- lm(tab_Tot$Mental_Health~tab_Tot$Work_Time)
summary(reg4)
plot(tab_Tot$Work_Time, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Work_Time, y = Mental_Health, color = LOCATION)) 
```

We have 0 and it doesn't seem to have any distinct correlation between this two variables 

6. GDP Analysis

```{r}
reg5 <- lm(tab_Tot$Mental_Health~tab_Tot$GDP)
summary(reg5)
plot(tab_Tot$GDP, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = GDP, y = Mental_Health , color = LOCATION))
```
We have ** and it seems that when the GDP tends to be high, the share of the population with mental health disorders also tends to be high.

The analysis of this first part still needs to be refined and improved.

We used many variables to test this effect of the work environment on mental health in these countrie. Thus we thought it wise to use a forward induction in order to define which of them are really significant. 

````{r}
mod0 <- lm(tab_Tot$Mental_Health~1)
summary(mod0)
mod1 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality)
summary(mod1)
mod2 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality+tab_Tot$wages)
summary(mod2)
mod3 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality+tab_Tot$wages+tab_Tot$Working_Age)
summary(mod3)
```
The result that we have is *** for Income_Inequality and ** for wages and working_Age.



## Covid-19

### Analysis 

Firstly, we would like to know if there is a correlation between Cases of Covid and the Value of Antidepressant Consumption through the years. We want to observe whether there is a peak in the consumption of these medications because of the covid crisis. Indeed, we make the hypothesis that due to this crisis, the proportion of people suffering from depression has increased, which would have had a significant impact on this consumption in 2020. 

```{r, echo = FALSE, message = FALSE}
Reg2 <- lm(tab_R2.1$Value~tab_R2.1$Cases...cumulative.total)
summary(Reg2)

cor(tab_R2.1$Value, tab_R2.1$Deaths...cumulative.total)
cor(tab_R2.1$Value, tab_R2.1$Cases...cumulative.total)
```

We obtain a correlation of "0,0049" between antidepressant consumption and the number of deaths due to covid, and a correlation of "0,0453" between antidepressant consumption and Covid cases.  
Unfortunately, we can see that there is no correlation between these variables, either with the number of cases or the number of deaths. 
We can give several explanations to this surprising observation.
The first one is the lack of data. Indeed, we were able to study the evolution of antidepressant consumption in only 8 countries. Perhaps with more countries, we would have seen a more significant difference. 

The second and the most likely, is that we can see that the number of cases (and deaths) related to covid are huge numbers, going from 0 to several millions (to thousands). However, compared to these numbers, the value of antidepressants consumption is increasing well as we can see in the graph below but not as much as the number of cases. The ratio is not the same. It would be interesting, later on, to calculate the value of the increase in consumption, by years and see if we can observe a difference between years or not. 

```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_R2.1) +
  geom_point(mapping = aes(x = TIME, y = Value, color = LOCATION))
```
```{r, echo = FALSE, message = FALSE}
tab_R2.1 <- ddply(Antidepressant_consumption1, .(LOCATION),
                                  function (d) {
                                    d$Growth <- c(NA, tail(d$Value, -1) - head(d$Value, -1))
                                    d
                                  }
)
aggregate(tab_R2.1[,4], list(tab_R2.1$LOCATION), mean, na.rm=T). --> #ATTENTION, a revoir j'ai fais moyenne de jusqu'en 2020 mais il faut faire que jusqu'en 2019
```

By creating a graph of consumption over time, we can see that consumption is increasing. However,  
By calculating the growth in antidepressant use each year and averaging it over time, when compared to the growth rate between 2019 and 2020, we cannot conclude with certainty that covid has had a significant impact on antidepressant use. Indeed, the value of growth between 2019 and 2020 is above average for 5 out of 8 countries.  (Portugal, Italy, Iceland, Hungary and Greece)


Given the results, we thought it would be more interesting to observe the rate of depression by country between 2000 and 2021. Here is the table of depression rate by selected countries in 2017 and 2021. This table was made because we could not find the data for the years 2018,2019 and 2020. So we wanted to compare these two dates to see if there was a significant difference. 
```{r}

ggplot(data = tab_R2.1.1) +
  geom_point(mapping = aes(x = TIME , y = VALUE, color = LOCATION))
```


Now that we see the increase, we will calculate the growth rate per year (from 2000 to 2017) and then make a projection, a hypothesis, for the following years including 2021, based on the values obtained. 
A new table must be created with values from 2000 to 2017 and 2021.  



We will now focus on our second study, which is the evolution of antidepressant consumption as a function of teleworking and unemployment rate. 

The following graph shows the evolution of antidepressant consumption, which is increasing. 
```{r}
ggplot(data = tab_R2.2) +
  geom_point(mapping = aes(x = TIME, y = Value, color = LOCATION))
```

```{r}
Reg2.2 <- lm(tab_R2.2$Value~tab_R2.2$Teleworking+tab_R2.2$Unemployment)
summary(Reg2.2)
```

With the *summary* function we can see a significant increase for one unit of  1.70310 * ValueAntidepressantConsumption for "Teleworking". This variable is significant with 2 stars wich is satisfying. However, the "Unemployment" is not significant as it represents an increase for one unit of 0.04958 * ValueAntidepressantConsumption. 

We can do a forward selection: 
```{r}
mod0 <- lm(tab_R2.2$Value~1)
summary(mod0)
mod1 <- lm(tab_R2.2$Value~tab_R2.2$Teleworking)
summary(mod1)
mod2 <- lm(tab_R2.2$Value~tab_R2.2$Teleworking+tab_R2.2$Unemployment)
summary(mod2)
```
Given the results, this confirms that unemployment is not significant and that this variable could be removed. That's why we will now now focus on teleworking which would have an impact on the consumption of antidepressants. 

Here is a graph that shows the increase in the value of the consumption according to the teleworking. 
```{r}
ggplot(data = tab_R2.2, mapping = aes(x = Value, y = Teleworking)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```


## Public spendings on health

### Analysis

Graphical observations and regression interpretation. 

 We observe the basic graph of the observations distributions.
```{r}
plot(Mental_health_Value ~ Value_Spending.on.health , tab_1)
```

We can try also with the logarithmic function.
```{r}
plot(log(Mental_health_Value) ~ log(Value_Spending.on.health), tab_1)
```


It looks like there is a positive correlation between the investments in a country and the prevalence of mental health disorder.
```{r}
cor(tab_1$Value_Spending.on.health , tab_1$Mental_health_Value)

Regression_Q.3.1 <- lm (tab_1$Mental_health_Value~tab_1$Value_Spending.on.health)

summary(Regression_Q.3.1)
```


- The first Regression_Q.3.1 shows a significant increase for one unit of 0.61843 * Value.Spending.on.health for the Mental_health_Value.
- The regression is significant with 3 stars, which is satisfying. 
- The R^2 is equal to 0.3653, which is moderated to low... It means that our model is explained by 37% of the variance.

We try the same regression but with the logarithmic function to see if something is more relevant or not.
```{r}
Regression_Q.3.1.log <- lm (log(tab_1$Mental_health_Value)~log(tab_1$Value_Spending.on.healt))

summary(Regression_Q.3.1.log)
```

We can see that it does not add drastically more information or explanation.


### VISUALIZATION 

Visualization of the Mental_health_Value evolution according to the Value_Spending.on.health in different countries. One point represent one year for each country.
```{r}
ggplot(data = tab_1) + geom_point(mapping = aes(x= Value_Spending.on.health, y = Mental_health_Value, color = LOCATION))
```

Different visualization of the graph.
```{r}
ggplot(data = tab_1, mapping = aes(x = Value_Spending.on.health, y = Mental_health_Value)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```

By adding a geom_line we can observe if the countries values differ from one year to another.
```{r}
tab_1 %>% group_by(LOCATION) %>%
  ggplot(aes(
    x = Value_Spending.on.health,
    y = Mental_health_Value,
    col = LOCATION,
    group = LOCATION
  )) +
  geom_line()
```

We can see that the values of the countries do not drastically differ from one year to an another. The evolution is quite linear.
It is why we apply the mean function to have one average value for the list of countries.

Aggregate The Value_Spending_on_health
```{r}
tab_Mean_Value_Spending.on.health <- aggregate(tab_1[,3], list(tab_1$LOCATION), mean)

tab_Mean_Value_Spending.on.health <- rename(tab_Mean_Value_Spending.on.health,c("LOCATION"="Group.1","Mean_Value_Spending.on.health"="x"))
```

Aggregate the Mental_health_Value
```{r}
tab_Mean_Mental_health_Value <- aggregate(tab_1[,4], list(tab_1$LOCATION), mean)

tab_Mean_Mental_health_Value <- rename(tab_Mean_Mental_health_Value,c("LOCATION"="Group.1","Mean_Mental_health_Value"="x"))
```

We merge the table into a new dataframe representing the mean values with respect to the countries into: tab_2
```{r}
tab_2 <- merge(tab_Mean_Value_Spending.on.health, tab_Mean_Mental_health_Value, by = 'LOCATION')
```


### Graphical observations and regression interpretation. 
```{r}
plot(tab_2)

plot(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, tab_2)
```

Now we want to add the LOCATION to the points in the graph. 
```{r}
plot(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, tab_2)
with(tab_2, text(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, labels = LOCATION, pos = 1, cex = 0.6))
```

We create a new regression with the mean values of the countries.
```{r}
Regression_Q.3.2 <- lm (tab_2$Mean_Mental_health_Value~ tab_2$Mean_Value_Spending.on.health)

summary(Regression_Q.3.2)
```

The first Regression_Q.3.1 shows a significant increase for one unit of 0.7073 * Value.Spending.on.health for the Mental_health_Value.
The regression is significant with 3 stars, which is satisfying. 
The R^2 is equal to 0.4208, which is moderated to low... It means that our model is explained by 42% of the variance.


### VISUALIZATION 

graph of our new dataframe tab_2.

```{r}
ggplot(data = tab_2)+ geom_point(mapping = aes(x= Mean_Value_Spending.on.health, y = Mean_Mental_health_Value, color = LOCATION))

ggplot(data = tab_2, mapping = aes(x = Mean_Value_Spending.on.health, y = Mean_Mental_health_Value)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth(se = FALSE)
```


First conclusion: Our first goal is to compare whether there is a link between the country's investment in health and the number of cases of mental health problems.

The hypothesis is that the more a country invests in health, the fewer mental health problems should be present because access to care is high. However, the data shows the opposite. The more a country spends on health, the more mental health problems are likely to occur. This may be related to several biases such as the richness of a country, or other factors. 

In this case it would be more relevant to study the reverse. Is a country with a lot of mental health problems a country that invests a lot in public health? 

Can we predict health expenditure according to the number of people affected by a mental illness in a specific country? 


###### REVERSE !!!!


### Graphical observations and regression interpretation. 
```{r}
plot( tab_2$Mean_Mental_health_Value, tab_2$Mean_Value_Spending.on.health)
```

Now we want to add the LOCATION to the points in the graph. 
```{r}
plot(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, tab_2)
with(tab_2, text(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, labels = LOCATION, pos = 1, cex = 0.6))
```

We create a new regression with the mean mental health value according to the mean value spending on health. 
```{r}
Regression_Q.3.3 <- lm (tab_2$Mean_Value_Spending.on.health ~ tab_2$Mean_Mental_health_Value )

summary(Regression_Q.3.3)
```

The first Regression_Q.3.3 shows a significant increase for one unit of 0.59493 * Mental_health_Value Value for the Spending.on.health 
The regression is significant with 3 stars, which is satisfying. 
The R^2 is equal to 0.42, which is moderated to low... It means that our model is explained by 42% of the variance.


### VISUALIZATION 
```{r}
ggplot(data = tab_2, mapping = aes(x = Mean_Mental_health_Value, y = Mean_Value_Spending.on.health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```

We can even identify clusters !

Indeed, with the following graph, we can see that the countries can be allocated to clusters according to their values.
```{r}
plot(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, tab_2)
with(tab_2, text(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, labels = LOCATION, pos = 1, cex = 0.6))
```



################  TEST OF CLUSTERS  #################

```{r}
data_test <- tab_2[-1]
data_test <- data_test[,c(2,1)]

mean_data <-apply(data_test, 2, mean)
mean_data

std <- apply(data_test,2,sd)
```

We have a normalized data
```{r}
data_test_std <- scale(data_test, mean_data,std)
row.names(data_test_std) <- tab_2[,1]
data_test_std
```

Computation of the euclidienne distance
```{r}
distance <- dist(data_test_std)
distance
print(distance, digits = 1)
```

We create the Cluster Dendogram
```{r}
hc <- hclust(distance)
plot(hc, labels= tab_2$LOCATION)
```

We calculate the average clusters
```{r}
avclust <- hclust(distance, method="average") 
plot(avclust, labels=tab_2$LOCATION)
```

Then we use an average-linkage model on the scaled data and use 6 clusters to show the difference:
```{r}
ct1 <- cutree(avclust, k=6)
plot(avclust, labels=tab_2$LOCATION) 
rect.hclust(avclust, k=6, border="red")
```


Study what is the optimal number of clusters k that is relevant to use
```{r}
fviz_nbclust(data_test_std, kmeans, method="wss")
```

We conclude that a number of 6 clusters is optimal because the total within sum of square  reduces only slightly from this point.

Graphical representation of the clusters 
```{r}
km.res <- kmeans(data_test_std, 6)
fviz_cluster(km.res, data=data_test_std, repel=TRUE)
```


