---
title: "Eda"
output: html_document
---


```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/Setup.R"))
```


Now all our databases are clean and ready to be used. 

# Exloratory data analysis:

Map representing the mental illness prevalence in the selected countries from the OCDE
```{r, echo = FALSE, message = FALSE}
mental.health <- read.csv2(here::here("Data/share.with.mental.and.substance.disorders.csv))


mental.health <- mental.health %>%
  filter(Entity %in% tab.of.countries$Entity )


mental.health <- rename(mental.health, 'mental_health_Value' = 'Prevalence...Mental.and.substance.use.disorders...Sex..Both...Age..Age.standardized..Percent.')


mental.health$mental_health_Value <- as.numeric(mental.health$mental_health_Value)

mental.health <- mental.health[-2]

mental.health.new <- mental.health %>%
  group_by(Entity,mental_health_Value) %>%
  filter(Year>1999)
mapdata <- map_data('world')
mapdata <- rename(mapdata,'Entity'='region')

mapdata2 <- left_join(mapdata, mental.health , by='Entity')

map.1 <- ggplot(mapdata2, aes(x=long, y=lat, group=group, labels=Entity))+
  geom_polygon(aes(fill=mental_health_Value))+
  scale_fill_gradient(low = '#56B1F7', high = '#132B43')
```

```{r}
ggplotly(map.1)
```



### Work environment 


# Table 1 : Representation of the rate of mental health disorder by country and region
# ATTENTION mettre dans ordre décroissant + enlever NA
```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_mean, aes(x = MentalHealth_mean, y=LOCATION)) + 
  geom_bar(stat='identity',fill="#DB7093",color="#DB7093",alpha=0.8) +
  geom_text(aes(label=round(MentalHealth_mean)),hjust=1,color='#4F2F4F') +
  xlab("Mental Health mean 2000-2017")+ ylab("Country")+
  ggtitle("Pas encore de titre")
```

On this first table, we can see that the Oceanian countries (Australia, New Zealand) are the ones that have a bigger part of their population with a mental disorder, followed by North America (Canada, USA) and Western Europe (France, Norway, Netherlands, Spain, Germany, Portugal). While Eastern European (Poland, Romania, Hungary, Czech Republic, Croatia) and Asian (Japan) countries have the lowest rate.  

# Table 2 : Evolution of the prevalence of mental health disorder over time and by country
```{r, echo = FALSE, message = FALSE}
Graph_MH <- tab %>% ggplot(aes(
  x = TIME,
  y = Mental_Health,
  group = Entity,
  color = LOCATION
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Evolution of the prevalence of mental health disorder in OCDE countries from 2000 to 2017") +
  xlab("Time") + ylab("Prevalence of mental health value in %") 
ggplotly(Graph_MH)
```

This second table shows that the prevalence of mental illness has hardly changed during the selected period from 2000 to 2017 for all countries in our database. Thus, we can conclude that time has no significant impact on the share of the population suffering from mental illness.

We now want to start studying our regression, that is, to see how the work environment, through the variables that compose it, impacts the percentage of mental health disorder in a country. For this we will do correlation analyses like those in our table 3.

# Table 3 : Correlation analyses between mental health and the work environment
# ATTENTION REFAIRE GRAPHIQUES
```{r, echo = FALSE, message = FALSE}
plot_tab <- plot(tab[3:9]) 
corrplot_tab <- corrplot(tab[3:9])
# MARCHE PAS ?
plot_grid(plot_tab, corrplot_tab, labels=c("A","B"), ncol=2, nrow=1)
```

Faire analyse quand on a le bon graph de corrélation 

We will check these hypotheses and the validity of our model by doing a regression.

# Table 4 : Regression study
```{r, echo = FALSE, message = FALSE}
mod <- lm(tab$Mental_Health ~ tab$Income_Inequality + tab$Wages + tab$Unemployment + tab$Working_Age + tab$Work_Time + tab$GDP)
summary(mod)
```

As expected, on table 4, we can see that our model is 75.5% explained by the variables we have chosen. Moreover, we notice that our variables, income inequality, wages, unemployment, working age and GDP are very significant. On the other hand, the time an employee spends working does not seem to have an impact on the rate of mental health disorder. We will therefore not take it into account as an explanatory variable for our problem. 

We will see more precisely with our table 5 how each of these variables impact these diseases, always according to the countries through 2000 and 2017.

# Table 5 : Impact of work environment's variables on mental health disorders by country
```{r, echo = FALSE, message = FALSE}
# Income Inequality Analysis 
GG0 <- ggplot(data = tab, mapping = aes(x = tab$Income_Inequality, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  xlab("Income inequality (Gini coef.") + ylab("Prevalence of mental health (in %)") 

# Wages Analysis
GG1 <- ggplot(data = tab, mapping = aes(x = tab$Wages, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()+
  xlab("Average wages (US$") + ylab("Prevalence of mental health (in %)") 

# Unemployment Analysis
GG2 <- ggplot(data = tab, mapping = aes(x = tab$Unemployment, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  xlab("Unemployment rate (in %)") + ylab("Prevalence of mental health (in %)") 

#Working Age Analysis
GG3 <- ggplot(data = tab, mapping = aes(x = tab$Working_Age, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  xlab("Working age population (in %)") + ylab("Prevalence of mental health (in %)") 

# GDP Analysis
GG4 <- ggplot(data = tab, mapping = aes(x = tab$GDP, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  xlab("GDP (US dollars/capita)") + ylab("Prevalence of mental health (in %)") 

# Put all the graphs together
plot_grid(GG0, GG1, GG2, GG3, GG4, labels=c("A","B","C","D","E","F"), ncol=2, nrow=3)
```

Using this graph and our table 4, we can make these important points about the impact of the work environment on mental health in a population:

A: The higher the income inequality in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

B: The higher the average wage in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

C: The higher the unemployment rate in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

D: The higher the percentage of a country's working-age population, the lower the proportion of its population with mental disorders. (+)

E: The higher the GDP of a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

In summary, a country with a medium wage, high GDP does not promote good mental health of workers. Second, high unemployment and income inequality worsen the mental health of a population. Nevertheless, if a country has a high proportion of working age population, it will have less problems related to the mental health of its workers.










## Covid-19

### Analysis 

Firstly, we would like to know if there is a correlation between Cases of Covid and the Value of Antidepressant Consumption through the years. We want to observe whether there is a peak in the consumption of these medications because of the covid crisis. Indeed, we make the hypothesis that due to this crisis, the proportion of people suffering from depression has increased, which would have had a significant impact on this consumption in 2020. 

# Graph1 : Antidepressant consumption per countries from 2000 to 2020 

```{r, echo = FALSE, message = FALSE}
graph.antidepressant.consumption <- ggplot(data = Antidepressant_consumption) +
  geom_point(mapping = aes(x = TIME, y = Consumption, color = LOCATION))+
  geom_line(mapping = aes(x = TIME, y = Consumption, color = LOCATION))
ggplotly(graph.antidepressant.consumption)
```
By creating a graph of antidepressant consumption over time, we can see that, for our first selection of countries, antidepressant consumption is increasing. We will see later if Covid Cases or Deaths are correlated to this increase.  


# Graph2 : Depression Rate per countries from 2000 to 2021

Due to lack of data on antidepressant use in 2020, it would be interesting to observe the rate of depression by country between 2000 and 2021. Here is the graph of depression rate by selected countries between 2000 and 2021. It is important to notice that we could not find the data for the years 2018,2019 and 2020. So we have no data available for these years. 

```{r, echo = FALSE, message = FALSE}
ggplot(data = Depression_Rate2000_2021)+
  geom_point(mapping = aes(x = TIME , y = Rate, color = LOCATION))+
  geom_line(mapping = aes(x = TIME , y = Rate, color = LOCATION))+
  theme_bw()
 ```

```{r, echo = FALSE, message = FALSE}

Depression_Rate2000_2021 <- Depression_Rate2000_2017 %>%
  rbind(Depression_Rate2021)%>%
  arrange(LOCATION,TIME)

Depression_Rate2000_2021 <- ddply(Depression_Rate2000_2021, .(LOCATION),
                                  function (d) {
                                    d$Growth <- c(NA, tail(d$Rate, -1) - head(d$Rate, -1))
                                    d
                                    }
                                  )
                                  
kabble(Depression_Rate2000_2021)

```
Here we have calculated the growth each year until 2017, and between 2017 and 2021 of the depression rate by country. We can indeed observe a growth over the years, but this increase is smaller and smaller over time. We can therefore make the assumption that this growth continues to decline through the years after 2017. Following this trend, we can well notice that the value in 2021 is unusual compared to previous years. There has been a strong increase in the depression rate in 2021, that we can well observe on the graph. 



# Graph3 : Evolution of teleworking through years 


We will now focus on our second study, which is the evolution of antidepressant consumption as a function of teleworking and unemployment rate. 

By making a graph of the evolution of the number of teleworkers compared to the number of workers per country, we can see an increase of this rate in 2020. This increase can be explained by the Covid crisis. So, if we find a potential correlation between the consumption of antidepressants and teleworking, we can then make a link with the Covid. 

```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_R2.2) +
  geom_point(mapping = aes(x = TIME, y = Teleworking, color = LOCATION))+
  geom_line(mapping = aes(x = TIME, y = Teleworking, color = LOCATION))
```

# Graph4 : Antidepressant consumption according to teleworking

```{r, echo = FALSE, message = FALSE}
Reg2.2 <- lm(tab_R2.2$Consumption~tab_R2.2$Teleworking+tab_R2.2$Unemployment+tab_R2.2$TIME)
summary(Reg2.2)
```

With the *summary* function we can see a significant increase for one unit of  1.70310 * ValueAntidepressantConsumption for "Teleworking". This variable is significant with 2 stars wich is satisfying. However, "Unemployment" is not significant as it represents an increase for one unit of 0.04958 * ValueAntidepressantConsumption. 
However, R^2 is equal to 0,0867 which means that our model is explained by 8,7% of the variance, which is not very satisfying. This means that variables we don't know, have a more significant impact on antidepressant consumption in a country.

Given the results, and that the variable "unemployment" has not a significant impact on antidepressant consumption, we will remove this variable for the rest of our analysis. We will now now focus on teleworking and analize the link between this variable and antidepressant consumption with different graphs. 

Here is a graph that shows the increase in the value of the consumption according to the teleworking. 
```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_R2.2, mapping = aes(x = Consumption, y = Teleworking)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```


## Public spendings on health

 Primary analysis
 
- Graphical observations and regression interpretation. 

```{r, echo = FALSE, message = FALSE}
 plot(tab_1)
```
In this general plot, we can assume that time is impacting the value spending on health. However, the impact on the mental health value seems close to zero.
Mental health and spendings on health looks positively correlated. 


Creation of a corrplot in order to identify directly the correlation coefficient between the variables.
```{r}
corrplot(cor(tab_1[4:6]), method = 'number')
```
With this corrplot, we can identify the correlation values for each variable. The mental health value, as our dependent variable (Y) as for coefficient value 0.6 with the value spending on health. As predicted with the initial plot, Time does not impact mental health because the value is close to 0 and does not appear on the graph.

```{r}
Graph.1 : Visualization of prevalence of mental health (% of the population) against Time for OCDE countries from 2000 to 2017 
Graph_Mental_Health <- Mental_Health_2 %>% ggplot(aes(
  x = Time,
  y = Mental_health_Value,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Evolution of the prevalence of mental health disorder in OCDE countries from 2000 to 2017") +
  xlab("Time") + ylab("Prevalence of mental health value in %") 
ggplotly(Graph_Mental_Health)
```
Visually, the Time does not affect the value of our dependent variable and it appears that the distribution of values is based on the location.
We can see that the prevalence of mental health disorder does not rise through time. Indeed the variation appears small over time and the correlation negative.

- Statistical analysis of Mental health value evolution and the time:
```{r, echo = FALSE, message = FALSE}
Regression.1.Time <- lm(tab_1$Mental_health_Value ~ tab_1$Time)
```
```{r}
summary(Regression.1.Time)
```
As visually analysed, the time does not impact our Y. The coefficient is not significant, the variance of the model is explained at 0.03% which is extremely low. The p-value is also high.
We conclude that this first model based only on ‘Time’ is bad. 

-Graph.2 : Visualization of the P) between the OCDE countries from 2000 to 2018
```{r}
Graph_public.spending.on.health <- Public.spending.on.health_New_2 %>% ggplot(aes(
  x = Time,
  y = Value_Spending.on.health,
  group = Entity,
  color = Region
)) +
  geom_path() +
  theme(axis.text.x = element_text(
    angle = 360,
    hjust = 1,
    vjust = 0.5
  )) +
  ggtitle("Evolution of the public spending on health in OCDE countries from 2000 to 2018") +
  xlab("Time") + ylab("Value spending on health in % of GDP") 
ggplotly(Graph_public.spending.on.health)
```
 It appears that the distribution of values is based on location, like mental health. And also, the values according to each country seems to slightly increase through Time.

Comparison of the 2 variables 
Now we want to compare the two variables: x = Value_Spending.on.health., y = Mental_health_Value In order to see if the expenditure on health of a country from the OCDE impacts the prevalence of mental illness in its population.

```{r}
Graph.region <- ggplot(tab_1, aes(x=Value_Spending.on.health, y=Mental_health_Value, colour=Region, group=Entity, labels=Time)) + geom_point()
ggplotly(Graph.region)
```

We observe that the two variables are positively correlated. However, it looks paradoxical, because the more a country invests on public health, the more there is the prevalence of mental illness.
Therefore, we decide to observe the opposite. Is a country suffering from a big proportion of mental illness, a country that invests the most on public health?
We decide to reverse the research question for this analysis because it is more logical to put  x = Mental_health_Value , y = Value_Spending.on.health.

```{r}
Graph.region2 <- ggplot(tab_1, aes( x = Mental_health_Value , y = Value_Spending.on.health, colour=Region, group=Entity, labels=Time)) +
  geom_point()
ggplotly(Graph.region2)
```
The fact that we allocate the colors to the region of the country is to shed the light on the distributions of the values according to the location in the world.
As a first result, the values are distributed in a similar way according to the region of the country.


 
 
 
 
 
 
 
 
