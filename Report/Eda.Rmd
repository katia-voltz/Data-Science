---
title: "Eda"
output: html_document
---


```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/Setup.R"))
```


Now all our databases are clean and ready to be used. 

# Exloratory data analysis:

- Visualization and representation of tables 
- Identification of relevant variables
- Interpretation of graphs and regressions

1/ Plot the all Tab
2/ Make assumptions about correlations between Y and Xi (by visualization of plot)
3/ Deeper visualization with ggplot between Y and Xi
4/ Create a linear regression
5/ Interpretation of regression and graphs


### Work environment 

# Table 1 : Representation of the rate of mental health disorder by country and region
# ATTENTION CHANGER TYPE DE GRAPHIQUE 
```{r}
g_countries <- ggplot(data = tab_mean, aes(y = MentalHealth_mean)) + 
  geom_bar(mapping = aes( color = LOCATION))

g_regions <- ggplot(data = tab_mean, aes(y = MentalHealth_mean)) + 
  geom_bar(mapping = aes( color = Region))

plot_grid(g_countries, g_regions, labels=c("A","B"), ncol=2, nrow=1)
```

On this first table, we can see that the Oceanian countries (Australia, New Zealand) are the ones that have a bigger part of their population with a mental disorder, followed by North America (Canada, USA) and Western Europe (France, Norway, Netherlands, Spain, Germany, Portugal). While Eastern European (Poland, Romania, Hungary, Czech Republic, Croatia) and Asian (Japan) countries have the lowest rate.  

# Table 2 : Evolution of the prevalence of mental health disorder over time and by country
```{r}
ggplot(data = tab, mapping = aes(x = TIME, y = Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```

This second table shows that the prevalence of mental illness has hardly changed during the selected period from 2000 to 2017 for all countries in our database. Thus, we can conclude that time has no significant impact on the share of the population suffering from mental illness.

We now want to start studying our regression, that is, to see how the work environment, through the variables that compose it, impacts the percentage of mental health disorder in a country. For this we will do correlation analyses like those in our table 3.

# Table 3 : Correlation analyses between mental health and the work environment
# ATTENTION REFAIRE GRAPHIQUES
```{r}
plot_tab <- plot(tab[3:9]) 
corrplot_tab <- corrplot(tab[3:9])
# MARCHE PAS ?
plot_grid(plot_tab, corrplot_tab, labels=c("A","B"), ncol=2, nrow=1)
```

Faire analyse quand on a le bon graph de corrÃ©lation 

We will check these hypotheses and the validity of our model by doing a regression.

# Table 4 : Regression study
```{r}
mod <- lm(tab$Mental_Health ~ tab$Income_Inequality + tab$Wages + tab$Unemployment + tab$Working_Age + tab$Work_Time + tab$GDP)
summary(mod)
```

As expected, on table 4, we can see that our model is 75.5% explained by the variables we have chosen. Moreover, we notice that our variables, income inequality, wages, unemployment, working age and GDP are very significant. On the other hand, the time an employee spends working does not seem to have an impact on the rate of mental health disorder. We will therefore not take it into account as an explanatory variable for our problem. 

We will see more precisely with our table 5 how each of these variables impact these diseases, always according to the countries through 2000 and 2017.

# Table 5 : Impact of work environment's variables on mental health disorders by country
```{r}
# Income Inequality Analysis 
GG0 <- ggplot(data = tab, mapping = aes(x = tab$Income_Inequality, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  ggtitle("Pas encore de titre") +
  xlab("X") + ylab("Y") 

# Wages Analysis
GG1 <- ggplot(data = tab, mapping = aes(x = tab$Wages, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()+
  ggtitle("Pas encore de titre") +
  xlab("X") + ylab("Y") 

# Unemployment Analysis
GG2 <- ggplot(data = tab, mapping = aes(x = tab$Unemployment, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  ggtitle("Pas encore de titre") +
  xlab("X") + ylab("Y") 

#Working Age Analysis
GG3 <- ggplot(data = tab, mapping = aes(x = tab$Working_Age, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  ggtitle("Pas encore de titre") +
  xlab("X") + ylab("Y") 

# GDP Analysis
GG4 <- ggplot(data = tab, mapping = aes(x = tab$GDP, y = tab$Mental_Health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth() +
  ggtitle("Pas encore de titre") +
  xlab("X") + ylab("Y") 

# Put all the graphs together
plot_grid(GG0, GG1, GG2, GG3, GG4, labels=c("A","B","C","D","E","F"), ncol=2, nrow=3)
```

Using this graph and our table 4, we can make these important points about the impact of the work environment on mental health in a population:

A: The higher the income inequality in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

B: The higher the average wage in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

C: The higher the unemployment rate in a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

D: The higher the percentage of a country's working-age population, the lower the proportion of its population with mental disorders. (+)

E: The higher the GDP of a country, the more likely that country will have a high proportion of its population with mental disorders. (-)

In summary, a country with a medium wage, high GDP does not promote good mental health of workers. Second, high unemployment and income inequality worsen the mental health of a population. Nevertheless, if a country has a high proportion of working age population, it will have less problems related to the mental health of its workers.







## Covid-19

### Analysis 

Firstly, we would like to know if there is a correlation between Cases of Covid and the Value of Antidepressant Consumption through the years. We want to observe whether there is a peak in the consumption of these medications because of the covid crisis. Indeed, we make the hypothesis that due to this crisis, the proportion of people suffering from depression has increased, which would have had a significant impact on this consumption in 2020. 

# Graph1 : Antidepressant consumption per countries from 2000 to 2020 

```{r, echo = FALSE, message = FALSE}
graph.antidepressant.consumption <- ggplot(data = Antidepressant_consumption) +
  geom_point(mapping = aes(x = TIME, y = Consumption, color = LOCATION))+
  geom_line(mapping = aes(x = TIME, y = Consumption, color = LOCATION))
ggplotly(graph.antidepressant.consumption)
```
By creating a graph of antidepressant consumption over time, we can see that, for our first selection of countries, antidepressant consumption is increasing. We will see later if Covid Cases or Deaths are correlated to this increase.  


# Graph2 : Depression Rate per countries from 2000 to 2021

Due to lack of data on antidepressant use in 2020, it would be interesting to observe the rate of depression by country between 2000 and 2021. Here is the graph of depression rate by selected countries between 2000 and 2021. It is important to notice that we could not find the data for the years 2018,2019 and 2020. So we have no data available for these years. 

```{r, echo = FALSE, message = FALSE}
ggplot(data = Depression_Rate2000_2021)+
  geom_point(mapping = aes(x = TIME , y = Rate, color = LOCATION))+
  geom_line(mapping = aes(x = TIME , y = Rate, color = LOCATION))+
  theme_bw()
 ```

```{r, echo = FALSE, message = FALSE}

Depression_Rate2000_2021 <- Depression_Rate2000_2017 %>%
  rbind(Depression_Rate2021)%>%
  arrange(LOCATION,TIME)

Depression_Rate2000_2021 <- ddply(Depression_Rate2000_2021, .(LOCATION),
                                  function (d) {
                                    d$Growth <- c(NA, tail(d$Rate, -1) - head(d$Rate, -1))
                                    d
                                    }
                                  )
```
Here we have calculated the growth each year until 2017, and between 2017 and 2021 of the depression rate by country. We can indeed observe a growth over the years, but this increase is smaller and smaller over time. We can therefore make the assumption that this growth continues to decline through the years after 2017. Following this trend, we can well notice that the value in 2021 is unusual compared to previous years. There has been a strong increase in the depression rate in 2021, that we can well observe on the graph. 



# Graph3 : Evolution of teleworking through years 


We will now focus on our second study, which is the evolution of antidepressant consumption as a function of teleworking and unemployment rate. 

By making a graph of the evolution of the number of teleworkers compared to the number of workers per country, we can see an increase of this rate in 2020. This increase can be explained by the Covid crisis. So, if we find a potential correlation between the consumption of antidepressants and teleworking, we can then make a link with the Covid. 

```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_R2.2) +
  geom_point(mapping = aes(x = TIME, y = Teleworking, color = LOCATION))+
  geom_line(mapping = aes(x = TIME, y = Teleworking, color = LOCATION))
```

# Graph4 : Antidepressant consumption according to teleworking ? 

```{r, echo = FALSE, message = FALSE}
Reg2.2 <- lm(tab_R2.2$Consumption~tab_R2.2$Teleworking+tab_R2.2$Unemployment)
summary(Reg2.2)
```

With the *summary* function we can see a significant increase for one unit of  1.70310 * ValueAntidepressantConsumption for "Teleworking". This variable is significant with 2 stars wich is satisfying. However, "Unemployment" is not significant as it represents an increase for one unit of 0.04958 * ValueAntidepressantConsumption. 
However, R^2 is equal to 0,0867 which means that our model is explained by 8,7% of the variance, which is not very satisfying. This means that variables we don't know, have a more significant impact on antidepressant consumption in a country.

Given the results, and that the variable "unemployment" has not a significant impact on antidepressant consumption, we will remove this variable for the rest of our analysis. We will now now focus on teleworking and analize the link between this variable and antidepressant consumption with different graphs. 

Here is a graph that shows the increase in the value of the consumption according to the teleworking. 
```{r, echo = FALSE, message = FALSE}
ggplot(data = tab_R2.2, mapping = aes(x = Consumption, y = Teleworking)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```


## Public spendings on health

### Analysis

Graphical observations and regression interpretation. 

 We observe the basic graph of the observations distributions.
```{r}
plot(Mental_health_Value ~ Value_Spending.on.health , tab_1)
```

We can try also with the logarithmic function.
```{r}
plot(log(Mental_health_Value) ~ log(Value_Spending.on.health), tab_1)
```


It looks like there is a positive correlation between the investments in a country and the prevalence of mental health disorder.
```{r}
cor(tab_1$Value_Spending.on.health , tab_1$Mental_health_Value)

Regression_Q.3.1 <- lm (tab_1$Mental_health_Value~tab_1$Value_Spending.on.health)

summary(Regression_Q.3.1)
```


- The first Regression_Q.3.1 shows a significant increase for one unit of 0.61843 * Value.Spending.on.health for the Mental_health_Value.
- The regression is significant with 3 stars, which is satisfying. 
- The R^2 is equal to 0.3653, which is moderated to low... It means that our model is explained by 37% of the variance.

We try the same regression but with the logarithmic function to see if something is more relevant or not.
```{r}
Regression_Q.3.1.log <- lm (log(tab_1$Mental_health_Value)~log(tab_1$Value_Spending.on.healt))

summary(Regression_Q.3.1.log)
```

We can see that it does not add drastically more information or explanation.


### VISUALIZATION 

Visualization of the Mental_health_Value evolution according to the Value_Spending.on.health in different countries. One point represent one year for each country.
```{r}
ggplot(data = tab_1) + geom_point(mapping = aes(x= Value_Spending.on.health, y = Mental_health_Value, color = LOCATION))
```

Different visualization of the graph.
```{r}
ggplot(data = tab_1, mapping = aes(x = Value_Spending.on.health, y = Mental_health_Value)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```

By adding a geom_line we can observe if the countries values differ from one year to another.
```{r}
tab_1 %>% group_by(LOCATION) %>%
  ggplot(aes(
    x = Value_Spending.on.health,
    y = Mental_health_Value,
    col = LOCATION,
    group = LOCATION
  )) +
  geom_line()
```

We can see that the values of the countries do not drastically differ from one year to an another. The evolution is quite linear.
It is why we apply the mean function to have one average value for the list of countries.

Aggregate The Value_Spending_on_health
```{r}
tab_Mean_Value_Spending.on.health <- aggregate(tab_1[,3], list(tab_1$LOCATION), mean)

tab_Mean_Value_Spending.on.health <- rename(tab_Mean_Value_Spending.on.health,c("LOCATION"="Group.1","Mean_Value_Spending.on.health"="x"))
```

Aggregate the Mental_health_Value
```{r}
tab_Mean_Mental_health_Value <- aggregate(tab_1[,4], list(tab_1$LOCATION), mean)

tab_Mean_Mental_health_Value <- rename(tab_Mean_Mental_health_Value,c("LOCATION"="Group.1","Mean_Mental_health_Value"="x"))
```

We merge the table into a new dataframe representing the mean values with respect to the countries into: tab_2
```{r}
tab_2 <- merge(tab_Mean_Value_Spending.on.health, tab_Mean_Mental_health_Value, by = 'LOCATION')
```


### Graphical observations and regression interpretation. 
```{r}
plot(tab_2)

plot(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, tab_2)
```

Now we want to add the LOCATION to the points in the graph. 
```{r}
plot(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, tab_2)
with(tab_2, text(Mean_Mental_health_Value ~ Mean_Value_Spending.on.health, labels = LOCATION, pos = 1, cex = 0.6))
```

We create a new regression with the mean values of the countries.
```{r}
Regression_Q.3.2 <- lm (tab_2$Mean_Mental_health_Value~ tab_2$Mean_Value_Spending.on.health)

summary(Regression_Q.3.2)
```

The first Regression_Q.3.1 shows a significant increase for one unit of 0.7073 * Value.Spending.on.health for the Mental_health_Value.
The regression is significant with 3 stars, which is satisfying. 
The R^2 is equal to 0.4208, which is moderated to low... It means that our model is explained by 42% of the variance.


### VISUALIZATION 

graph of our new dataframe tab_2.

```{r}
ggplot(data = tab_2)+ geom_point(mapping = aes(x= Mean_Value_Spending.on.health, y = Mean_Mental_health_Value, color = LOCATION))

ggplot(data = tab_2, mapping = aes(x = Mean_Value_Spending.on.health, y = Mean_Mental_health_Value)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth(se = FALSE)
```


First conclusion: Our first goal is to compare whether there is a link between the country's investment in health and the number of cases of mental health problems.

The hypothesis is that the more a country invests in health, the fewer mental health problems should be present because access to care is high. However, the data shows the opposite. The more a country spends on health, the more mental health problems are likely to occur. This may be related to several biases such as the richness of a country, or other factors. 

In this case it would be more relevant to study the reverse. Is a country with a lot of mental health problems a country that invests a lot in public health? 

Can we predict health expenditure according to the number of people affected by a mental illness in a specific country? 


###### REVERSE !!!!


### Graphical observations and regression interpretation. 
```{r}
plot( tab_2$Mean_Mental_health_Value, tab_2$Mean_Value_Spending.on.health)
```

Now we want to add the LOCATION to the points in the graph. 
```{r}
plot(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, tab_2)
with(tab_2, text(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, labels = LOCATION, pos = 1, cex = 0.6))
```

We create a new regression with the mean mental health value according to the mean value spending on health. 
```{r}
Regression_Q.3.3 <- lm (tab_2$Mean_Value_Spending.on.health ~ tab_2$Mean_Mental_health_Value )

summary(Regression_Q.3.3)
```

The first Regression_Q.3.3 shows a significant increase for one unit of 0.59493 * Mental_health_Value Value for the Spending.on.health 
The regression is significant with 3 stars, which is satisfying. 
The R^2 is equal to 0.42, which is moderated to low... It means that our model is explained by 42% of the variance.


### VISUALIZATION 
```{r}
ggplot(data = tab_2, mapping = aes(x = Mean_Mental_health_Value, y = Mean_Value_Spending.on.health)) +
  geom_point(mapping = aes(color = LOCATION)) +
  geom_smooth()
```

We can even identify clusters !

Indeed, with the following graph, we can see that the countries can be allocated to clusters according to their values.
```{r}
plot(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, tab_2)
with(tab_2, text(Mean_Value_Spending.on.health ~ Mean_Mental_health_Value, labels = LOCATION, pos = 1, cex = 0.6))
```



################  TEST OF CLUSTERS  #################

```{r}
data_test <- tab_2[-1]
data_test <- data_test[,c(2,1)]

mean_data <-apply(data_test, 2, mean)
mean_data

std <- apply(data_test,2,sd)
```

We have a normalized data
```{r}
data_test_std <- scale(data_test, mean_data,std)
row.names(data_test_std) <- tab_2[,1]
data_test_std
```

Computation of the euclidienne distance
```{r}
distance <- dist(data_test_std)
distance
print(distance, digits = 1)
```

We create the Cluster Dendogram
```{r}
hc <- hclust(distance)
plot(hc, labels= tab_2$LOCATION)
```

We calculate the average clusters
```{r}
avclust <- hclust(distance, method="average") 
plot(avclust, labels=tab_2$LOCATION)
```

Then we use an average-linkage model on the scaled data and use 6 clusters to show the difference:
```{r}
ct1 <- cutree(avclust, k=6)
plot(avclust, labels=tab_2$LOCATION) 
rect.hclust(avclust, k=6, border="red")
```


Study what is the optimal number of clusters k that is relevant to use
```{r}
fviz_nbclust(data_test_std, kmeans, method="wss")
```

We conclude that a number of 6 clusters is optimal because the total within sum of square  reduces only slightly from this point.

Graphical representation of the clusters 
```{r}
km.res <- kmeans(data_test_std, 6)
fviz_cluster(km.res, data=data_test_std, repel=TRUE)
```


