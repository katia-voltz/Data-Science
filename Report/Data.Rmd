---
title: "Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # supprimer ? a quoi il sert ?
```

First, we need to install different packages. 

```{r, echo=FALSE, message=FALSE}
library(plyr)
library(dbplyr)
library(tidyverse)
library(tibble)
library(corrplot)
library(car)
#faire un code qui ouvre tous les packages dans un autre file (--> setup.R)
```

For our research, we are going to use different datasets for our three main themes. 

## Work Environment

First of all, for the database concerning the environment at work, we have extracted all the data from the sites : <https://www.oecd.org> and <https://ourworldindata.org>. 

Our first resarch question was : Given the structure of the working environment in different countries, can we say that the mental health of the population is influenced by the working conditions and the situation of the country?

To see those effects , we have chosen the information of 6 variables ; 

- the average work-time
- the GPD
- the unemployment rate 
- the working age population
- the salaries
- the income inequalities 

 --> Regression 1 : MentalHealth = x1*IncomeInequality + x2*wages + x3*Unemployment + x4*WorkingAgePopulation + x5*WorkTime + x6*GPD

We start by installing the libraries and packages we will need for this part of the analysis.

```{r}
library(plyr)
library(dplyr)
library(corrplot)
library(ggplot2)
library(car)
packages <- c("ggrepel", "gghighlight", "patchwork", "scales") 
```
We have made a selection of several countries which are the following (To simplify, country codes have been used and not the full names) : Austria, Belgium, Croatia, Czechia, Denmark, Finland, France, Germany, Greece, Hungary, Iceland, Ireland, Italy, Romania, Portugal, Poland, Norway, Netherlands, Switzerland, Sweden, Spain, Australia, Brazil, Canada, Japan, New-Zealand and the USA.  

```{r}
List.of.Countries = c('AUT','BEL','HRV', 'CZE', 'DNK', 'ENG', 'FIN', 'FRA', 'DEU', 'GRC', 'HUN', 'ISL', 'ITA', 'ROU', 'PRT', 'POL', 'NOR', 'NLD', 'CHE', 'SWE', 'ESP', 'AUS', 'BRA', 'CAN', 'JPN', 'NZL', 'USA)
```

Now that we have collected all our data, we need to sort, order and rename them in order to obtain only tables with three columns to have the value of our variable according to its country and its date. We took the data for each of these variables for a certain sample of countries and then chose to do an individual average over the years from 2000 to 2017.

```{r}
ental_Health <- read.csv("Mental Health.csv")
attach(Mental_Health)
Mental_Health <- Mental_Health[,-1]
Mental_Health <- rename(Mental_Health,c("LOCATION"="Code", "TIME"="Year","ValueH"="Prevalence...Mental.and.substance.use.disorders...Sex..Both...Age..Age.standardized..Percent."))
Mental_Health <-  Mental_Health %>% filter(LOCATION %in% List.of.Countries)
Mental_Health <- Mental_Health %>%
  filter(TIME>1999, TIME< 2018)
Mental_Health_m <- aggregate(Mental_Health[,3], list(Mental_Health$LOCATION), mean)
Mental_Health_m <- rename(Mental_Health_m,c("LOCATION"="Group.1","Mean_1"="x"))

Income_Inequality <- read.csv2("Income inequality-1.csv")
attach(Income_Inequality)
Income_Inequality <- Income_Inequality[,-c(2:5,8)]
Income_Inequality$Value <- as.numeric(Income_Inequality$Value)
Income_Inequality <-  Income_Inequality %>% filter(LOCATION %in% List.of.Countries)
Income_Inequality <- Income_Inequality %>%
  filter(TIME>1999, TIME< 2018)
Income_Inequality_m <- aggregate(Income_Inequality[,3], list(Income_Inequality$LOCATION), mean)
Income_Inequality_m <- rename(Income_Inequality_m,c("LOCATION"="Group.1","Mean_2"="x"))

wages <- read.csv("Average wages.csv")
attach(wages)
wages <- wages[,-c(2:5,8)]
wages <-  wages %>% filter(LOCATION %in% List.of.Countries)
wages <- wages %>%
  filter(TIME>1999, TIME< 2018)
wages_m <- aggregate(wages[,3], list(wages$LOCATION), mean)
wages_m <- rename(wages_m,c("LOCATION"="Group.1","Mean_3"="x"))

Unemployment <- read.csv("Unemployement Rate.csv")
attach(Unemployment)
Unemployment <- Unemployment[,-c(2:5,8)]
Unemployment <-  Unemployment %>% filter(LOCATION %in% List.of.Countries)
Unemployment <- Unemployment %>%
  filter(TIME>1999, TIME< 2018)
Unemployment_m <- aggregate(Unemployment[,3], list(Unemployment$LOCATION), mean)
Unemployment_m <- rename(Unemployment_m,c("LOCATION"="Group.1","Mean_4"="x"))

Working_Age <- read.csv("Working age population.csv")
attach(Working_Age)
Working_Age <- Working_Age[,-c(2:5,8)]
Working_Age <-  Working_Age %>% filter(LOCATION %in% List.of.Countries)
Working_Age_m <- aggregate(Working_Age[,3], list(Working_Age$LOCATION), mean)
Working_Age_m <- rename(Working_Age_m,c("LOCATION"="Group.1","Mean_5"="x"))

Work_Time <- read.csv("Avg Work Time.csv")
attach(Work_Time)
Work_Time <- Work_Time[,-c(2:5,8)]
Work_Time <-  Work_Time %>% filter(LOCATION %in% List.of.Countries)
Work_Time <- Work_Time %>%
  filter(TIME>1999, TIME< 2018)
Work_Time_m <- aggregate(Work_Time[,3], list(Work_Time$LOCATION), mean)
Work_Time_m <- rename(Work_Time_m,c("LOCATION"="Group.1","Mean_6"="x"))

GDP <- read.csv("gdp-per-capita.csv")
attach(GDP)
GDP <- GDP[,-c(1,5)]
GDP <- rename(GDP,c("LOCATION"="Code", "TIME"="Year"))
GDP <-  GDP %>% filter(LOCATION %in% List.of.Countries)
GDP <- GDP %>%
  filter(TIME>1999, TIME< 2018)
GDP_m <- aggregate(GDP[,3], list(GDP$LOCATION), mean)
GDP_m <- rename(GDP_m,c("LOCATION"="Group.1","Mean_7"="x"))
```

Now that we have all our variables in the right format, we need to put them in a common table so that we can have an overall representation and be able to observe and analyze the trends that emerge.

```{r}
tab_0 <- full_join(Mental_Health_m, Income_Inequality_m, by = c("LOCATION"))
tab_1 <- full_join(tab_0, wages_m, by = c("LOCATION"))
tab_2 <- full_join(tab_1, Unemployment_m, by = c("LOCATION"))
tab_3 <- full_join(tab_2, Working_Age_m, by = c("LOCATION"))
tab_4 <- full_join(tab_3, Work_Time_m, by = c("LOCATION"))
tab_R1 <- full_join(tab_4, GDP_m, by = c("LOCATION"))
tab_R1 <- na.omit(tab_R1)
tab_R1 <- rename(tab_R1, c("Mental_Health"="Mean_1","Income_Inequality"="Mean_2","wages"="Mean_3","Unemployment"="Mean_4","Working_Age"="Mean_5","Work_Time"="Mean_6","GDP"="Mean_7"))
```
Because of the large amount of data we used, some countries were left out due to lack of information, which made them insufficient to compare with others.

As our linear relationship doesn't seem satisfying, we decide to flatten our values and obtain more meaningful results, we converted our table using the log function. 

````{r}
tab_R1_log <- log(tab_R1[,2:8])
tab_Tot <- cbind(tab_R1$LOCATION, tab_R1_log)
tab_Tot <- rename(tab_Tot, c("LOCATION"="tab_R1$LOCATION"))
View(tab_Tot)
plot(tab_Tot)
```
This table and its plot allow us to do correlation tests and to have visual representations of all these movements.

1. Income Inequality Analysis 

````{r}
reg0 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality)
summary(reg0)
plot(tab_Tot$Income_Inequality, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Income_Inequality, y = Mental_Health, color = LOCATION))
```

We have *  and we can see that the higher the income inequality, the higher the share of the population with mental health disorders is.

2. Wages Analysis

````{r}
reg1 <- lm(tab_Tot$Mental_Health~tab_Tot$wages)
summary(reg1)
plot(tab_Tot$wages, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = wages, y = Mental_Health , color = LOCATION))
```

We have **  and we can see that the higher the wages, the higher the share of the share of the population with mental health disorders is.

3. Unemployment Analysis

````{r}
reg2 <- lm(tab_Tot$Mental_Health~tab_Tot$Unemployment)
summary(reg2)
plot(tab_Tot$Unemployment, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Unemployment, y = Mental_Health , color = LOCATION))
```

We have 0 and it doesn't seem to have any distinct correlation between this two variables.

4. Working Age Analysis

````{r}
reg3 <- lm(tab_Tot$Mental_Health~tab_Tot$Working_Age)
summary(reg3)
plot(tab_Tot$Working_Age, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Working_Age, y = Mental_Health , color = LOCATION))
```

We have ** and we can see that the share of the population with mental health disorders is higher when the working age is lower.

5. Work Time Analysis

````{r}
reg4 <- lm(tab_Tot$Mental_Health~tab_Tot$Work_Time)
summary(reg4)
plot(tab_Tot$Work_Time, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = Work_Time, y = Mental_Health, color = LOCATION)) ```

We have 0 and it doesn't seem to have any distinct correlation between this two variables 

6. GDP Analysis

````{r}
reg5 <- lm(tab_Tot$Mental_Health~tab_Tot$GDP)
summary(reg5)
plot(tab_Tot$GDP, tab_Tot$Mental_Health)
ggplot(data = tab_Tot) + geom_point(mapping = aes(x = GDP, y = Mental_Health , color = LOCATION))
```
We have ** and it seems that when the GDP tends to be high, the share of the population with mental health disorders also tends to be high.

######################################################################################################

We used many variables to test this effect of the work environment on mental health in these countrie. Thus we thought it wise to use a forward induction in order to define which of them are really significant. 

````{r}
mod0 <- lm(tab_Tot$Mental_Health~1)
summary(mod0)
mod1 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality)
summary(mod1)
mod2 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality+tab_Tot$wages)
summary(mod2)
mod3 <- lm(tab_Tot$Mental_Health~tab_Tot$Income_Inequality+tab_Tot$wages+tab_Tot$Working_Age)
summary(mod3)
```
The result that we have is *** for Income_Inequality and ** for wages and working_Age.


"Anxiety" and "Depression" are two of the major determinants of our mental health variable. Our next objective is therefore to analyze whether one or the other would have a significant impact on the work environment.

````{r}
Anxiety <- read.csv("share-with-anxiety-disorders.csv")
attach(Anxiety)
Anxiety <- Anxiety[,-1]
Anxiety <- rename(Anxiety ,c("LOCATION"="Code", "TIME"="Year"))
Anxiety <-  Anxiety %>% filter(LOCATION %in% List.of.Countries)
Anxiety <- Anxiety %>%
  filter(TIME>1999, TIME< 2018)
Anxiety_m <- aggregate(Anxiety[,3], list(Anxiety$LOCATION), mean)
Anxiety_m <- rename(Anxiety_m,c("LOCATION"="Group.1","Mean_1"="x"))

Depression <- read.csv("dalys-depression-age-std-rate.csv")
attach(Depression)
Depression <- Depression[,-1]
Depression <- rename(Depression ,c("LOCATION"="Code", "TIME"="Year"))
Depression <-  Depression %>% filter(LOCATION %in% List.of.Countries)
Depression <- Depression %>%
  filter(TIME>1999, TIME< 2018)
Depression_m <- aggregate(Depression[,3], list(Depression$LOCATION), mean)
Depression_m <- rename(Depression_m,c("LOCATION"="Group.1","Mean_1"="x"))
```





## Covid

For our second theme around Covid, we want to analyze if Covid had an impact on antidepressant 
consumption in selected countries around the world. We found data on antidepressant consumption on the website : <https://www.oecd.org>, in the Pharmaceutical Market Section. 
Regarding the Covid data, they come from the site : <https://coronavirus.jhu.edu>. 

Regression 2.1 : Antidepressant_consumption = a*Number_Covid-19_cases + b*Number_Covid-19_Death

First of all, we have made a selection of several countries which are the following (To simplify, country codes have been used and not the full names) : Austria, Belgium, Croatia, Czechia, Denmark, Finland, France, Germany, Greece, Hungary, Iceland, Ireland, Italy, Romania, Portugal, Poland, Norway, Netherlands, Switzerland, Sweden, Spain, Australia, Brazil, Canada, China, Japan, New-Zealand and the USA.  

```{r}
List.of.Countries = c('AUT','BEL','HRV', 'CZE', 'DNK', 'ENG', 'FIN', 'FRA', 'DEU', 'GRC', 'HUN','ISL',
                      'ITA', 'ROU', 'PRT', 'POL', 'NOR', 'NLD', 'CHE', 'SWE', 'ESP', 'AUS', 'BRA',
                      'CAN', 'CHN', 'JPN', 'NZL', 'USA')
```

For this first analysis related to the impact of Covid, R2.1, we quickly realized that the data available for antidepressant consumption in 2020 was very limited. We had to make a second selection of countries for this regression in order to observe only the countries with data in 2020, during the covid year. 

```{r}
List.of.Countries2 = c('GRC', 'HUN', 'ISL', 'ITA', 'NOR','PRT', 'SWE', 'ESP')
```

Now we can select and sort the data. 
```{r}
Antidepressant_consumption <- read.csv("Conso Antidepressant.csv") #--> Mettre un code qui sélectionne la donnée depuis le bon emplacement : read.csv(here::here("data/Conso Antidepressant.csv")) ? 
attach(Antidepressant_consumption)
```

For all the variables we only kept the columns on the country, the date and the value of the variable, because they were the only ones that interested us. All the others have therefore been deleted.
It was also often necessary to rename the columns so that they all follow the scheme: LOCATION, TIME and VALUE. 

```{r}
Antidepressant_consumption <- Antidepressant_consumption[,-c(1:4,6:7,10:11)]
Antidepressant_consumption <- rename(Antidepressant_consumption,c("LOCATION"="COU","TIME"="Year"))
Antidepressant_consumption <- Antidepressant_consumption %>% filter(LOCATION %in% List.of.Countries)
Antidepressant_consumption1 <- Antidepressant_consumption %>% filter(LOCATION %in% List.of.Countries2)
View(Antidepressant_consumption)
```

We had to add a column with the date 2020 for the covid data, because it was not present. 
```{r}
Number_Covid19_cases_deaths <- read.csv2("Cases + Deaths Covid.csv")
attach(Number_Covid19_cases_deaths)
Number_Covid19_cases_deaths <- Number_Covid19_cases_deaths[,-c(1,2,4:7,9:12)]
Number_Covid19_cases_deaths <- Number_Covid19_cases_deaths[-1,] 
Number_Covid19_cases_deaths <- rename(Number_Covid19_cases_deaths, "LOCATION"="Code")
Number_Covid19_cases_deaths <- Number_Covid19_cases_deaths %>% add_column(TIME = 2020, .after = "LOCATION") 
Number_Covid19_cases_deaths <-  Number_Covid19_cases_deaths %>% filter(LOCATION %in% List.of.Countries)
Number_Covid19_cases_deaths1 <-  Number_Covid19_cases_deaths %>% filter(LOCATION %in% List.of.Countries2)
View(Number_Covid19_cases_deaths)
```

We can now form a table with all the data together, using the *full_join* function. 

```{r}
tab_R2.1 <- full_join(Number_Covid19_cases_deaths1, Antidepressant_consumption1, by= c("LOCATION","TIME"))
```

As the data of cases and death of the covid for the years before 2020 were displayed in NA, we assumed that its values were equal to 0. Also, the "cases" variable was output in character, we converted it to numeric.

```{r}
tab_R2.1[is.na(tab_R2.1)] <- 0 
tab_R2.1$Cases...cumulative.total <- as.numeric(tab_R2.1$Cases...cumulative.total)
View(tab_R2.1)
```
Our table on the use of antidepressants and the number of cases and deaths of covid is now ready to be used. 

Given the little information we had on antidepressant consumption in 2020 (only for 8 countries) we decided to observe the rate of depression and finally include it in our research question.
We therefore wanted to analyze the evolution of the depression rate between 2010 and 2017, and if the covid had an impact on it in 2021. Our data comes from the sites : <https://ourworldindata.org/mental-health#depression> and <https://worldpopulationreview.com/>. 

```{r}
Depression_Rate2000_2017 <- read.csv("Depression Rate 2000:2017.csv")
attach(Depression_Rate2000_2017)
View(Depression_Rate2000_2017)
```

Here too we have only kept the country, the year and the value, and renamed the columns.As the years start before 2000, we have to make a selection of the years after 1999, to keep only what interests us. 

```{r}
Depression_Rate2000_2017 <- Depression_Rate2000_2017[-1]
Depression_Rate2000_2017 <- rename(Depression_Rate2000_2017,c("LOCATION"="Code","TIME"="Year","Value"="Prevalence...Depressive.disorders...Sex..Both...Age..Age.standardized..Percent."))
Depression_Rate2000_2017 <- Depression_Rate2000_2017 %>% filter(LOCATION %in% List.of.Countries)
Depression_Rate2000_2017 <- Depression_Rate2000_2017 %>%
  filter(TIME>1999)
Depression_Rate2017 <- Depression_Rate2000_2017 %>%
  filter(TIME>2016)
Depression_Rate2017 <- rename(Depression_Rate2017,c("2017"="Value"))
Depression_Rate2017 <- Depression_Rate2017[-2]
View(Depression_Rate2017)
```

We did exactly the same thing for the depression rate in 2021. 
```{r}
Depression_Rate2021 <- read.csv2("Depression Rate 2021.csv")
attach(Depression_Rate2021)
Depression_Rate2021 <- Depression_Rate2021[,-c(1,3:4)]
Depression_Rate2021 <- rename(Depression_Rate2021,c("2021"="prevalence"))
Depression_Rate2021 <- Depression_Rate2021 %>% filter(LOCATION %in% List.of.Countries)
Depression_Rate2021 <- Depression_Rate2021 %>% add_column(TIME = 2021, .after = "LOCATION") 
Depression_Rate2021 <- Depression_Rate2021[-3]
View(Depression_Rate2021)
```

Then, we had to join the two tables into one, using both *inner_join* and *pivot_longer* in order to obtain a table that we could use correctly afterwards to do analyses. 

```{r}
tab_R2.1.1 <- Depression_Rate2017 %>%
  inner_join(Depression_Rate2021, by = "LOCATION")
tab_R2.1.1$"2021" <- as.numeric(tab_R2.1.1$"2021")
tab_R2.1.1 <- tab_R2.1.1 %>%
  pivot_longer(c(`2017`, `2021`),
               names_to = "TIME",
               values_to = "VALUE")
View(tab_R2.1.1)
```

For the second study of this theme, we want to see whether teleworking and unemployment rates can affect antidepressant use in selected countries. Information on Teleworking and Unemployment rate were extracted respectively from the sites : <https://ec.europa.eu/eurostat> and <https://data.oecd.org>. 

We will now use the data of antidepressant according to the first selected country list. 
```{r}
View(Antidepressant_consumption)
```

As above, we have kept only the columns we were interested in, i.e. value, date and country, and we have renamed some inadequate columns. 

```{r}
Teleworking <- read.csv2("Teleworking.csv")
attach(Teleworking)
Teleworking <- Teleworking[,-c(1:8,12)]
Teleworking <- rename(Teleworking,c("LOCATION"="geo","TIME"="TIME_PERIOD","Teleworking"="OBS_VALUE"))
Teleworking <-  Teleworking %>% filter(LOCATION %in% List.of.Countries)
View(Teleworking)
```

We also did this for the unemployment rate. 

```{r}
UnemploymentCovid <- read.csv("Unemployement Rate.csv")
attach(UnemploymentCovid)
UnemploymentCovid <- UnemploymentCovid[,-c(2:5,8)]
UnemploymentCovid <- rename(UnemploymentCovid, c("Unemployment"="Value"))
UnemploymentCovid <-  UnemploymentCovid %>% filter(LOCATION %in% List.of.Countries)
View(UnemploymentCovid)
```

With the *full_join* function we have gathered the data of these three variables in a single table.
For the good functioning of the table for further analysis, it was necessary to remove the NA values, and to convert the variable "teleworking" in numerical (which was in character). 

```{r}
tab <- full_join(Antidepressant_consumption, Teleworking, by=c("LOCATION", "TIME"))
tab_R2.2 <- full_join(tab, UnemploymentCovid, by = c("LOCATION", "TIME"))
tab_R2.2 <- na.omit(tab_R2.2)
tab_R2.2$Teleworking <- as.numeric(tab_R2.2$Teleworking)
View(tab_R2.2)
```



